"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[814],{4814:function(e,t,r){r.d(t,{Z:function(){return m}});var n=r(7437),a=r(2265),o=r(8398),l=r(1064),i=r(3972),c=r(6463),s=r(636),u=r(2462),d=r(7257);let f=(e,t)=>{let r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=window.URL.createObjectURL(r),a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",t),a.click(),window.URL.revokeObjectURL(n)};var p=r(1334),m=e=>{let{reAttemptUrl:t,showFilter:r,attempt:m,taskID:y,videoURL:h}=e,g=(0,a.useRef)(null),v=(0,a.useRef)(null),[w,b]=(0,a.useState)(0),[E,x]=(0,a.useState)([]),[S,k]=(0,a.useState)([]),[D,T]=(0,a.useState)(!0),[_,A]=(0,a.useState)(""),{state:N,dispatch:j}=(0,u.y)(),R=(0,a.useRef)(null),C=(0,a.useRef)(null),F=(0,c.useRouter)(),L="".concat(p._,"/model/mediapipe/task-vision"),U="".concat(p._,"/model/mediapipe/face-landmark/face_landmarker.task");(0,a.useEffect)(()=>{r&&O().then(()=>{V()})},[r]);let O=async()=>{A("Loading MediaPipe model for gaze detection...");try{var e;let t=await o.n.forVisionTasks(L);R.current=await o.jr.createFromOptions(t,{baseOptions:{modelAssetPath:U,delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1}),C.current=new o.ET(null===(e=v.current)||void 0===e?void 0:e.getContext("2d")),A("Model loaded successfully")}catch(t){let e=t instanceof Error?t.message:String(t);throw A("Error loading model: ".concat(e)),console.error("Detailed error:",t),Error("Unable to load face landmark model")}},V=async()=>{A("Fetching video data...");try{if(h){g.current&&(g.current.src=h,g.current.addEventListener("loadeddata",()=>{P()}));return}let e=await (0,l.VS)(d.Y.temporaryDB,d.Y.tempVideo);if(e){let t=(0,i.o)(e,"video/webm"),r=URL.createObjectURL(t);g.current&&(g.current.src=r,g.current.addEventListener("loadeddata",()=>{P()}))}else A("Couldn't retrieve key ".concat(d.Y.tempVideo," from ").concat(d.Y.temporaryDB," database."))}catch(e){A("Error fetching video"),console.error("Error fetching video:",e)}},P=async()=>{if(A("processing video..."),!g.current||!v.current)return;let e=g.current,t=v.current,r=t.getContext("2d");e.width=720,e.height=400,t.width=720,t.height=400;try{await e.play()}catch(e){A("Error playing video"),console.error("Error playing video:",e);return}let n=-1,a=async l=>{try{if(l-n<33.333333333333336){requestAnimationFrame(a);return}n=l,r.clearRect(0,0,t.width,t.height);let i=performance.now();if(!R.current||"function"!=typeof R.current.detectForVideo)throw Error("faceLandmarkerRef.current model is unavailable");let c=await R.current.detectForVideo(e,i);if((null==c?void 0:c.faceLandmarks)&&C.current){for(let e of c.faceLandmarks)C.current.drawConnectors(e,o.jr.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1});let t=c.faceLandmarks[0],r=null==t?void 0:t[33],n=null==t?void 0:t[263],a=(0,s.z_)({leftEye:r,rightEye:n})||0;A("Perceived distance bw eyes: ".concat(a.toFixed(2)," cm"));let l=parseFloat(e.currentTime.toFixed(3))||0;S.push(l),E.push(a)}let u=e.currentTime/e.duration*100;if(b(u),e.paused||e.ended){f(E,"gaze");let e={...N[y]["attempt".concat(m)],gazeDistance:E,gazeTiming:S};j({type:"UPDATE_SURVEY_DATA",attempt:m,task:y,data:e}),A("Processing complete! Data saved.")}else requestAnimationFrame(a)}catch(e){A("Error processing video"),console.error("Video processing error:",e)}finally{T(!1)}};T(!0),requestAnimationFrame(a)};return(0,n.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center align-middle",children:(0,n.jsxs)("div",{className:"w-full bg-white container max-w-3xl rounded-md",children:[(0,n.jsx)("div",{className:"w-full flex items-start justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600",children:(0,n.jsx)("h3",{className:"text-xl capitalize text-center font-semibold text-gray-900",children:D?"Wait while we process the video.":"Hurray, You have completed the survey!"})}),(0,n.jsxs)("div",{className:"p-4",children:[D&&(0,n.jsx)("p",{id:"eye-direction",className:"text-center text-gray-400 text-base",children:_}),(0,n.jsxs)("div",{className:"w-full h-[300px] max-w-2xl m-auto flex flex-col items-center relative",children:[(0,n.jsx)("video",{className:"absolute h-full w-full max-w-xl rounded-lg bg-gray-800",id:"webcam",ref:g,playsInline:!0,muted:!0,children:"Your browser does not support the video tag."}),(0,n.jsx)("canvas",{className:"absolute h-full w-full rounded-lg",id:"output_canvas",ref:v}),D&&(0,n.jsx)("p",{children:"We are processing the video, please wait..."})]}),D&&(0,n.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mt-4",children:(0,n.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(w,"%")}})})]}),(0,n.jsxs)("div",{className:"w-full flex items-center justify-center p-4 border-t border-gray-200 rounded-b dark:border-gray-600",children:[(0,n.jsx)("button",{disabled:D,onClick:()=>F.push("/survey"),className:"".concat(D?"cursor-not-allowed opacity-50":"cursor-pointer"," capitalize text-white bg-red-800 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:hover:bg-red-700 dark:focus:ring-red-800"),children:"Go to Dashboard"}),t&&(0,n.jsx)("button",{disabled:D,onClick:()=>{!D&&window.location&&(window.location.href=t)},className:"".concat(D?"cursor-not-allowed opacity-50":"cursor-pointer"," ms-3 text-gray-200 bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-red-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"),children:"Create New Attempt"})]})]})})}},1334:function(e,t,r){r.d(t,{_:function(){return n}});let n="/start"},7257:function(e,t,r){r.d(t,{Y:function(){return a},g:function(){return n}});let n={LOGGED_IN_USER:"start_user",MFA_ACCESS_TOKEN:"x-secure-token",MFA_REFRESH_TOKEN:"x-refresh-token",SELECTED_COUNTRY:"psychSelectedCountry",SELECTED_COUNTRY_NAME:"psychSelectedCountryName",SELECTED_VENDORCODE:"psychSelectedVendorCode",SELECTED_LANGUAGE:"psychSelectedLanguageFilter",BASE_URL:"https://x3qrf2-3000.csb.app/api/v1",SURVEY_DATA:"surveyData"},a={surveyDB:"survey",surveyData:"surveyData",useData:"user",tempVideo:"tempVideo",temporaryDB:"temporary"}},3972:function(e,t,r){r.d(t,{l:function(){return n},o:function(){return a}});let n=e=>new Promise((t,r)=>{let n=new FileReader;n.onloadend=()=>{n.result?t(n.result.split(",")[1]):r("Failed to convert file to base64")},n.onerror=()=>{r("File reading error")},n.readAsDataURL(e)});function a(e,t,r){let n=atob(e.split(",")[1]||e),a=n.length,o=new Uint8Array(a);for(let e=0;e<a;e++)o[e]=n.charCodeAt(e);let l=new Blob([o],{type:t});if(!r){let e=t.split("/")[1]||"file";r="file.".concat(e)}return new File([l],r,{type:t})}},2462:function(e,t,r){r.d(t,{SurveyProvider:function(){return m},y:function(){return y}});var n=r(7437),a=r(7257);let{childID:o,childDOB:l,childGender:i}=(0,r(7413).jy)(a.g.LOGGED_IN_USER,!0)||{},c=e=>({assestment_id:e,noOfAttempt:0,attempt1:{},attempt2:{},attempt3:{},userID:""});c("BubblePoppingTask"),c("MotorFollowingTask"),c("ButtonTask");let s=["BubblePoppingTask","DelayedGratificationTask","MotorFollowingTask","ButtonTask","SynchronyTask","LanguageSamplingTask","WheelTask","PreferentialLookingTask"].reduce((e,t)=>(e[t]={...c(t),userID:o,userDOB:l,userGender:i},e),{});var u=r(1064),d=r(2265);let f=(0,d.createContext)(void 0),p=(e,t)=>{switch(t.type){case"SET_SURVEY_DATA":return{...e,...t.payload};case"UPDATE_SURVEY_DATA":var r;return{...e,[t.task]:{...e[t.task],noOfAttempt:t.attempt,["attempt".concat(t.attempt)]:{...null===(r=e[t.task])||void 0===r?void 0:r["attempt".concat(null==t?void 0:t.attempt)],...t.data}}};default:return{...e}}},m=e=>{let{children:t}=e,[r,o]=(0,d.useReducer)(p,s),[l,i]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{(async()=>{try{let e=await (0,u.VS)(a.Y.surveyDB,a.Y.surveyData);e&&!l&&o({type:"SET_SURVEY_DATA",payload:e})}catch(e){console.error("Failed to load persisted survey state:",e)}finally{i(!0)}})()},[l]),(0,d.useEffect)(()=>{l&&(async()=>{try{await (0,u.TP)(a.Y.surveyDB,a.Y.surveyData,r)}catch(e){console.error("Failed to save survey state:",e)}})()},[r,l]),(0,n.jsx)(f.Provider,{value:{state:r,dispatch:o},children:t})},y=()=>{let e=(0,d.useContext)(f);if(!e)throw Error("useSurveyContext must be used within a SurveyProvider");return e}},1064:function(e,t,r){function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new Promise((r,n)=>{let a=indexedDB.open(e,t);a.onsuccess=()=>r(a.result),a.onerror=()=>n("Failed to open database: ".concat(e)),a.onupgradeneeded=()=>{let e=a.result;e.objectStoreNames.contains("data")||e.createObjectStore("data")}})}async function a(e,t,r){try{let a=await n(e),o=a.transaction("data","readwrite");o.objectStore("data").put(r,t),o.oncomplete=()=>{a.close()},o.onerror=t=>{console.error("Transaction error in ".concat(e,":"),t)}}catch(t){console.error("Error setting value in ".concat(e,":"),t)}}async function o(e,t){try{let r=await n(e);return new Promise((n,a)=>{let o=r.transaction("data","readonly").objectStore("data").get(t);o.onsuccess=()=>{let e=o.result;n(e),r.close()},o.onerror=()=>{a("Failed to retrieve data from ".concat(e)),r.close()}})}catch(t){return console.error("Error getting value from ".concat(e,":"),t),null}}r.d(t,{TP:function(){return a},VS:function(){return o}})},7413:function(e,t,r){function n(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("localStorage"in window)try{let r=window.localStorage.getItem(e);if(!r)return null;if(!t)return r;if(r)return JSON.parse(r)}catch(e){}return null}function a(e,t,r){if("localStorage"in window)try{r?window.localStorage.setItem(e,JSON.stringify(t)):"string"==typeof t&&window.localStorage.setItem(e,t)}catch(e){console.log(e)}return null}r.d(t,{jy:function(){return n},uN:function(){return a}})},636:function(e,t,r){function n(e){if(!(null==e?void 0:e[468])||!(null==e?void 0:e[473])||!(null==e?void 0:e[33])||!(null==e?void 0:e[263]))return"Invalid landmarks";let t=e[468],r=e[473],n=e[33],a=e[263];function o(e,t){let r=e.x-t.x,n=e.y-t.y;return Math.sqrt(r*r+n*n)}let l=o(t,n),i=o(r,a);return l>i?"left":i>l?"right":"center"}r.d(t,{Kr:function(){return n},z_:function(){return a}});let a=e=>{let{leftEye:t,rightEye:r}=e;return t&&r?Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2)):0}}}]);